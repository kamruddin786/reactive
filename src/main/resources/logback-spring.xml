<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- Local development profile -->
    <springProfile name="!k8s">
        <!-- Simple console logging for local development -->
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss} - %msg%n</pattern>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- GKE/Kubernetes profile -->
    <springProfile name="k8s">
        <!-- JSON structured logging for GCP Cloud Logging -->
        <appender name="STDOUT_JSON" class="ch.qos.logback.core.ConsoleAppender">
            <target>System.out</target>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp>
                        <fieldName>timestamp</fieldName>
                        <timeZone>UTC</timeZone>
                    </timestamp>
                    <!-- Map logback level to GCP severity -->
                    <logLevel>
                        <fieldName>severity</fieldName>
                    </logLevel>
                    <loggerName>
                        <fieldName>logger</fieldName>
                    </loggerName>
                    <threadName>
                        <fieldName>thread</fieldName>
                    </threadName>
                    <message>
                        <fieldName>message</fieldName>
                    </message>
                    <stackTrace>
                        <fieldName>stack_trace</fieldName>
                    </stackTrace>
                    <mdc/> <!-- Includes traceId, spanId, etc. -->
                    <!-- Add custom fields that are automatically parsed by GCP -->
                    <globalCustomFields>
                        <customFields>
                            {
                                "serviceContext": {
                                    "service": "reactive-sse-app",
                                    "version": "v1.0"
                                },
                                "context": {
                                    "pod": "${HOSTNAME:-unknown}",
                                    "environment": "gke"
                                }
                            }
                        </customFields>
                    </globalCustomFields>
                </providers>
            </encoder>
        </appender>

        <!-- Rolling file appender for /tmp directory -->
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/tmp/reactive-sse-app.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
                <fileNamePattern>/tmp/reactive-sse-app.%i.log</fileNamePattern>
                <minIndex>1</minIndex>
                <maxIndex>5</maxIndex>
            </rollingPolicy>
            <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
                <maxFileSize>2MB</maxFileSize>
            </triggeringPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>

        <root level="INFO">
            <appender-ref ref="STDOUT_JSON"/>
            <appender-ref ref="FILE"/>
        </root>

        <!-- Enhanced SSE logging -->
        <logger name="com.kamruddin.reactive.controllers.ReactiveNotificationController" level="DEBUG" additivity="false">
            <appender-ref ref="STDOUT_JSON"/>
            <appender-ref ref="FILE"/>
        </logger>
        <logger name="com.kamruddin.reactive.services.MessageNotificationConsumer" level="DEBUG" additivity="false">
            <appender-ref ref="STDOUT_JSON"/>
            <appender-ref ref="FILE"/>
        </logger>

        <!-- Network and connection logging -->
        <logger name="reactor.netty" level="DEBUG" additivity="false">
            <appender-ref ref="STDOUT_JSON"/>
            <appender-ref ref="FILE"/>
        </logger>
        <logger name="org.springframework.web.reactive" level="DEBUG" additivity="false">
            <appender-ref ref="STDOUT_JSON"/>
            <appender-ref ref="FILE"/>
        </logger>
    </springProfile>
</configuration>
